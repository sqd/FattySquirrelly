<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.6.2/phaser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.1/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.6.1/addons/p5.sound.min.js"></script>


    <script src="tracking.js/tracking-min.js"></script>

</head>
<body>
    <video id="video" width="320" height="240" style="position: absolute;right: 0px;bottom: 0px;" preload autoplay loop muted></video>

    <script>
    var sqPos = 'middle', sqDes = undefined;
    var sqStatus = 'running';
    var sq = undefined;
    var walkAnim = undefined, changeLeftAnim = undefined, changeRightAnim = undefined;
    var debugText = undefined;
    var colorTracker = undefined;
    colorTracker = new tracking.ColorTracker('magenta');
    tracking.track('#video', colorTracker, { camera: true });
    colorTracker.on('track', function(event) {
        if(event.data.length > 0){
            var x = event.data[0].x;
            var newState = 'right'
            if(x > 60) newState = 'middle';
            if(x > 130) newState = 'left';
            if(newState != sqPos){
                if(sqStatus != 'toChangeLane' && sqStatus != 'changingLane'){
                    sqDes = newState;
                    sqStatus = 'toChangeLane';
                }
            }

        }
    });

    var mic = new p5.AudioIn();
    mic.start();

    var game = new Phaser.Game(1024, 768, Phaser.AUTO, '', { preload: preload, create: create, update: update });

    function preload() {
        game.load.image('background', 'assets/background.jpg');
        game.load.spritesheet('sprite', 'assets/squirrel/sprite.png', 400, 300, 10);


    }

    function create() {
        game.add.sprite(0, 0, 'background');
        sq = game.add.sprite(335, 400, 'sprite');
        walkAnim = sq.animations.add('walk', [4,2,0,2,4,5,3,1,3,5], true);
        changeLeftAnim = sq.animations.add('jump_left', [2,0,9,7,0,2,4], false);
        changeRightAnim = sq.animations.add('jump_right', [3,1,8,6,1,3,5], false);

        debugText = game.add.text(0, 0, "debug text");
        
        changeRightAnim.onComplete.add(function(){
            walkAnim.play(6, true);
            sqPos = sqDes;
            sqDes = undefined;
            sqStatus = 'running';
            switch(sqPos){
                case 'right':
                sq.x = 580;
                break;
                case 'middle':
                sq.x = 335;
                break;
            }
            console.log('change completed')
        }, this);
        changeLeftAnim.onComplete.add(function(){
            walkAnim.play(6, true);
            sqPos = sqDes;
            sqDes = undefined;
            sqStatus = 'running';
            switch(sqPos){
                case 'left':
                sq.x = 100;
                break;
                case 'middle':
                sq.x = 335;
                break;
            }
            console.log('change completed')
        }, this);
        
        walkAnim.play(6, true);

        //game.time.events.loop(Phaser.Timer.SECOND, undefined, this);
    }

    function update() {
        /*
        var micLevel = mic.getLevel();
        if(micLevel > 0.15 && sqStatus == 'running'){
            sqStatus = 'jumping';
            //TODO: anim
            //anim.onComplete
        }
        */
        debugText.setText(sqStatus + ' ' + sqPos);
        //console.log(1);
        if(sqStatus == 'toChangeLane'){
            sqStatus = 'changingLane';
            console.log('changing');
            if(sqPos == 'right' || sqPos == 'left')
                sqDes = 'middle';
            sq.animations.stop();
            var m = {
                'left' : 0,
                'middle' : 1,
                'right' : 2
            };
            if(m[sqDes] - m[sqPos] > 0){
                changeRightAnim.play(6, false);
                sq.x += 125;
            }
            else{
                changeLeftAnim.play(6, false);
                sq.x -= 125;
            }
        }
    }



    </script>

</body>
</html>